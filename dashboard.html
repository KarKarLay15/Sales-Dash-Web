<!DOCTYPE html>
<html lang="my" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Sales Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7fe;
            --card-bg-color: #ffffff;
            --text-color: #1a202c;
            --text-muted-color: #718096;
            --border-color: #e2e8f0;
            --primary-color: #2563eb;
            --primary-hover-color: #1d4ed8;
            --primary-start-color: #4f46e5;
            --primary-end-color: #7c3aed;
            --toast-bg: #192133;
            --toast-text: #e2e8f0;
        }

        html.dark {
            --bg-color: #0b1120;
            --card-bg-color: #192133;
            --text-color: #e2e8f0;
            --text-muted-color: #a0aec0;
            --border-color: #2d3748;
            --toast-bg: #e2e8f0;
            --toast-text: #1a202c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .card {
            background-color: var(--card-bg-color);
            transition: background-color 0.3s, box-shadow 0.3s, transform 0.3s;
            border: 1px solid var(--border-color);
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: translateY(0);
        }

        .btn-primary-solid {
            background-color: var(--primary-color);
        }
        .btn-primary-solid:hover {
            background-color: var(--primary-hover-color);
            box-shadow: 0 7px 14px rgba(37, 99, 235, 0.25), 0 3px 6px rgba(0, 0, 0, 0.08);
        }

        .form-input {
             background-color: var(--bg-color);
             border-color: var(--border-color);
        }
        .form-input:focus {
            --tw-ring-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .modal {
            transition: opacity 0.25s ease;
            backdrop-filter: blur(5px);
        }

        .tab {
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            color: var(--primary-start-color);
            border-bottom-color: var(--primary-start-color);
        }
        html.dark .tab.active {
            color: #a78bfa;
            border-bottom-color: #a78bfa;
        }
        
        .pagination-btn {
            min-width: 40px;
        }
        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dropdown-menu {
            animation: slideIn 0.2s ease-out forwards;
        }

        @keyframes toastIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes toastOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }
        .toast-in { animation: toastIn 0.5s ease-out forwards; }
        .toast-out { animation: toastOut 0.5s ease-in forwards; }
        
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 26px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 3px; content: ""; height: 20px; left: 3px; position: absolute; transition: .4s; width: 20px; border-radius: 50%; }
        input:checked + .slider { background-image: linear-gradient(to right, var(--primary-start-color), var(--primary-end-color)); }
        input:checked + .slider:before { transform: translateX(24px); }

        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- MODIFICATION: New Auth Section Layout -->
    <div id="auth-section" class="min-h-screen bg-slate-50 dark:bg-gray-900 grid lg:grid-cols-2">
        <!-- Left Info Panel -->
        <div class="hidden lg:flex flex-col justify-center items-center bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-12">
            <div class="max-w-md text-center">
                <div class="flex items-center justify-center gap-4 mb-6">
                    <i class="fas fa-chart-line text-5xl"></i>
                    <h1 class="text-5xl font-bold">SalesDash</h1>
                </div>
                <p class="text-lg text-indigo-200 mb-8">သင့်ရဲ့နေ့စဉ်အရောင်းအဝယ်တွေကို လွယ်ကူစွာ စီမံခန့်ခွဲပြီး အမြတ်အစွန်းကို ခြေရာခံပါ။</p>
                <div class="space-y-4 text-left">
                    <div class="flex items-start gap-4">
                        <i class="fas fa-check-circle text-2xl text-green-400 mt-1"></i>
                        <div>
                            <h3 class="font-semibold">Real-time Data Sync</h3>
                            <p class="text-indigo-200 text-sm">Data များကို အချိန်နဲ့တပြေးညီ သိမ်းဆည်းပြီး မည်သည့်နေရာကမဆို ကြည့်ရှုနိုင်ခြင်း။</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4">
                        <i class="fas fa-check-circle text-2xl text-green-400 mt-1"></i>
                        <div>
                            <h3 class="font-semibold">Offline Access</h3>
                            <p class="text-indigo-200 text-sm">အင်တာနက်မရှိချိန်တွင်လည်း စာရင်းများထည့်သွင်းနိုင်ပြီး online ပြန်ဖြစ်ချိန်တွင် အလိုအလျောက် sync လုပ်ပေးခြင်း။</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-4">
                        <i class="fas fa-check-circle text-2xl text-green-400 mt-1"></i>
                        <div>
                            <h3 class="font-semibold">Data Export</h3>
                            <p class="text-indigo-200 text-sm">သင်၏အရောင်းစာရင်းများကို CSV file ဖြင့် အလွယ်တကူ export လုပ်နိုင်ခြင်း။</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Login Form Panel -->
        <div class="flex flex-col items-center justify-center p-6 sm:p-12">
            <div class="absolute top-6 right-6">
                 <div class="theme-switch-wrapper flex items-center gap-3">
                    <i class="fas fa-sun text-yellow-500"></i>
                    <label class="theme-switch" for="auth-theme-toggle">
                        <input type="checkbox" id="auth-theme-toggle">
                        <span class="slider round"></span>
                    </label>
                    <i class="fas fa-moon text-indigo-300"></i>
                </div>
            </div>
            <div class="max-w-sm w-full">
                 <div class="lg:hidden flex items-center gap-3 mb-8">
                    <i class="fas fa-chart-line text-2xl text-[var(--primary-color)]"></i>
                    <span class="text-2xl font-bold">SalesDash</span>
                </div>
                <h2 class="text-3xl font-bold">Welcome Back!</h2>
                <p class="text-sm text-[var(--text-muted-color)] mt-1 mb-8">Please login to your account</p>
                
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-[var(--text-muted-color)] mb-1">Email</label>
                        <input type="email" id="email" placeholder="you@example.com" class="form-input w-full px-4 py-3 rounded-lg focus:ring-2" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-[var(--text-muted-color)] mb-1">Password</label>
                        <input type="password" id="password" placeholder="••••••••" class="form-input w-full px-4 py-3 rounded-lg focus:ring-2" required>
                    </div>
                    <p id="auth-error" class="text-sm text-center h-4"></p>
                    <div class="pt-2">
                        <button type="submit" id="login-btn" class="btn btn-primary-solid w-full text-white font-bold py-3 px-4 rounded-lg flex justify-center items-center">
                            <span class="btn-text">Login</span>
                            <i class="fas fa-spinner spinner hidden ml-2"></i>
                        </button>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-[var(--text-muted-color)]">
                            Don't have an account? 
                            <button type="button" id="register-btn" class="font-medium text-[var(--primary-color)] hover:underline">Create one</button>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- App Section -->
    <div id="app" class="container mx-auto p-2 sm:p-4 md:p-6 lg:p-8 max-w-7xl hidden">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 sm:mb-10 gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-[var(--primary-start-color)] to-[var(--primary-end-color)]">Sales Dashboard</h1>
                <div class="flex items-center gap-2 mt-2">
                    <div id="connection-status" class="w-3 h-3 rounded-full bg-gray-400 transition-colors" title="Connecting..."></div>
                    <p id="user-email-display" class="text-[var(--text-muted-color)] text-sm"></p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="theme-switch-wrapper flex items-center gap-3">
                    <i class="fas fa-sun text-yellow-500"></i>
                    <label class="theme-switch" for="app-theme-toggle">
                        <input type="checkbox" id="app-theme-toggle">
                        <span class="slider round"></span>
                    </label>
                    <i class="fas fa-moon text-indigo-300"></i>
                </div>
                
                <!-- MODIFICATION: New "More" Dropdown Menu -->
                <div class="relative">
                    <button id="more-menu-btn" class="bg-gray-200 dark:bg-gray-700 text-[var(--text-color)] font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition flex items-center gap-2">
                        <span>More</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="more-menu-dropdown" class="dropdown-menu absolute right-0 mt-2 w-64 card rounded-lg shadow-xl z-20 hidden">
                        <div class="p-4 border-b border-[var(--border-color)]">
                            <p class="font-semibold text-sm">Signed in as</p>
                            <p id="dropdown-user-email" class="text-sm truncate text-[var(--text-muted-color)]"></p>
                        </div>
                        <div class="py-2">
                            <a href="#" id="menu-profile-btn" class="flex items-center px-4 py-2 text-sm hover:bg-[var(--bg-color)]">
                                <i class="fas fa-user-cog w-6 text-center mr-2 text-[var(--text-muted-color)]"></i> Profile Settings
                            </a>
                            <a href="#" id="menu-security-btn" class="flex items-center px-4 py-2 text-sm hover:bg-[var(--bg-color)]">
                                <i class="fas fa-shield-alt w-6 text-center mr-2 text-[var(--text-muted-color)]"></i> Security
                            </a>
                            <a href="#" id="menu-privacy-btn" class="flex items-center px-4 py-2 text-sm hover:bg-[var(--bg-color)]">
                                <i class="fas fa-user-shield w-6 text-center mr-2 text-[var(--text-muted-color)]"></i> Personal Data & Privacy
                            </a>
                        </div>
                        <div class="py-2 border-t border-[var(--border-color)]">
                            <a href="#" id="menu-about-btn" class="flex items-center px-4 py-2 text-sm hover:bg-[var(--bg-color)]">
                                <i class="fas fa-info-circle w-6 text-center mr-2 text-[var(--text-muted-color)]"></i> About SalesDash
                            </a>
                             <a href="#" id="menu-developer-btn" class="flex items-center px-4 py-2 text-sm hover:bg-[var(--bg-color)]">
                                <i class="fas fa-code w-6 text-center mr-2 text-[var(--text-muted-color)]"></i> Developer
                            </a>
                        </div>
                        <div class="p-2 border-t border-[var(--border-color)]">
                            <button id="logout-btn" class="w-full text-left flex items-center px-4 py-2 text-sm text-red-500 hover:bg-red-500 hover:text-white rounded-md">
                               <i class="fas fa-sign-out-alt w-6 text-center mr-2"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
                 <div class="card p-4 sm:p-6 rounded-2xl fade-in relative overflow-hidden">
                    <i class="fa-solid fa-sack-dollar absolute -right-4 -top-4 text-8xl text-green-500/10"></i>
                    <h3 class="text-[var(--text-muted-color)] font-semibold mb-2 uppercase text-sm tracking-wider">ယနေ့ရောင်းရငွေ</h3>
                    <p id="today-total" class="text-3xl font-bold text-green-500">0 MMK</p>
                </div>
                 <div class="card p-4 sm:p-6 rounded-2xl fade-in relative overflow-hidden" style="animation-delay: 100ms;">
                    <i class="fa-solid fa-arrow-trend-up absolute -right-4 -top-4 text-8xl text-teal-500/10"></i>
                    <h3 class="text-[var(--text-muted-color)] font-semibold mb-2 uppercase text-sm tracking-wider">ယနေ့အမြတ်</h3>
                    <p id="today-profit" class="text-3xl font-bold text-teal-500">0 MMK</p>
                </div>
                 <div class="card p-4 sm:p-6 rounded-2xl fade-in relative overflow-hidden" style="animation-delay: 200ms;">
                    <i class="fa-solid fa-chart-line absolute -right-4 -top-4 text-8xl text-blue-500/10"></i>
                    <h3 class="text-[var(--text-muted-color)] font-semibold mb-2 uppercase text-sm tracking-wider">ယခုလရောင်းရငွေ</h3>
                    <p id="month-total" class="text-3xl font-bold text-blue-500">0 MMK</p>
                </div>
                 <div class="card p-4 sm:p-6 rounded-2xl fade-in relative overflow-hidden" style="animation-delay: 300ms;">
                    <i class="fa-solid fa-chart-pie absolute -right-4 -top-4 text-8xl text-indigo-500/10"></i>
                    <h3 class="text-[var(--text-muted-color)] font-semibold mb-2 uppercase text-sm tracking-wider">ယခုလအမြတ်</h3>
                    <p id="month-profit" class="text-3xl font-bold text-indigo-500">0 MMK</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="mb-8 border-b border-[var(--border-color)]">
                <nav class="flex space-x-4 sm:space-x-8" aria-label="Tabs">
                    <button id="tab-daily" class="tab active py-4 px-1 font-medium text-base sm:text-lg">
                        <i class="fas fa-calendar-day mr-2"></i>နေ့စဉ်စာရင်း
                    </button>
                    <button id="tab-monthly" class="tab py-4 px-1 font-medium text-base sm:text-lg text-[var(--text-muted-color)]">
                        <i class="fas fa-table mr-2"></i>လချုပ်စာရင်း
                    </button>
                </nav>
            </div>

            <!-- Daily View Content -->
            <div id="daily-view">
                <!-- Add Sale Form -->
                <div class="card p-4 sm:p-6 md:p-8 rounded-2xl mb-8 fade-in" style="animation-delay: 400ms;">
                    <h2 class="text-2xl font-bold mb-6 border-b border-[var(--border-color)] pb-4">အရောင်းအသစ်ထည့်ရန်</h2>
                    <form id="add-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                        <div>
                            <label for="sale-date" class="block text-sm font-medium text-[var(--text-muted-color)] mb-1">ရက်စွဲ</label>
                            <input type="date" id="sale-date" class="form-input w-full px-4 py-2 rounded-lg focus:ring-2" required>
                        </div>
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-[var(--text-muted-color)] mb-1">Product</label>
                            <input type="text" id="product-name" list="product-list" value="VPN" class="form-input w-full px-4 py-2 rounded-lg focus:ring-2" required>
                            <datalist id="product-list"></datalist>
                        </div>
                        <div>
                            <label for="vpn-plan" class="block text-sm font-medium text-[var(--text-muted-color)] mb-1">Plan</label>
                            <input type="text" id="vpn-plan" list="plan-list" value="1 Month" class="form-input w-full px-4 py-2 rounded-lg focus:ring-2" required>
                            <datalist id="plan-list"></datalist>
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-[var(--text-muted-color)] mb-1">အရေအတွက်</label>
                            <input type="number" id="quantity" min="1" value="1" class="form-input w-full px-4 py-2 rounded-lg focus:ring-2" required>
                        </div>
                        <div>
                            <label for="price" class="block text-sm font-medium text-[var(--text-muted-color)] mb-1">ရောင်းဈေး (တစ်ခု)</label>
                            <input type="number" id="price" min="0" placeholder="0" class="form-input w-full px-4 py-2 rounded-lg focus:ring-2" required>
                        </div>
                         <div>
                            <label for="cost" class="block text-sm font-medium text-[var(--text-muted-color)] mb-1">ကုန်ကျငွေ (တစ်ခု)</label>
                            <input type="number" id="cost" min="0" value="0" class="form-input w-full px-4 py-2 rounded-lg focus:ring-2" required>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <button type="submit" id="add-sale-btn" class="btn btn-primary-solid w-full text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 flex items-center justify-center gap-2">
                                <i class="fas fa-plus-circle"></i>
                                <span>စာရင်းသွင်းမည်</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Sales List -->
                <div class="p-1 fade-in" style="animation-delay: 500ms;">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold">အရောင်းစာရင်း</h2>
                        <div class="flex flex-wrap items-center gap-4 p-2 card rounded-xl">
                            <div class="relative flex-grow">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-muted-color)]"></i>
                                <input type="text" id="search-input" placeholder="Search product or plan..." class="form-input w-full pl-10 pr-4 py-2 rounded-lg focus:ring-1">
                            </div>
                            <div class="flex items-center space-x-2">
                               <label for="filter-start-date" class="text-sm font-medium text-[var(--text-muted-color)]">From:</label>
                               <input type="date" id="filter-start-date" class="form-input px-3 py-2 rounded-lg focus:ring-1 w-36">
                            </div>
                            <div class="flex items-center space-x-2">
                               <label for="filter-end-date" class="text-sm font-medium text-[var(--text-muted-color)]">To:</label>
                               <input type="date" id="filter-end-date" class="form-input px-3 py-2 rounded-lg focus:ring-1 w-36">
                            </div>
                            <button id="clear-filter-btn" class="text-sm text-[var(--primary-start-color)] hover:underline">Clear</button>
                            <div class="flex gap-2">
                                <button id="export-csv-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 text-sm flex items-center gap-2" title="Export filtered results">
                                    <i class="fas fa-file-csv"></i>
                                   <span class="hidden sm:inline">Export Filtered</span>
                                </button>
                                <button id="export-all-csv-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 text-sm flex items-center gap-2" title="Export all records">
                                    <i class="fas fa-file-alt"></i>
                                   <span class="hidden sm:inline">Export All</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="sales-list-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6">
                        <!-- Sale cards will be inserted here -->
                    </div>
                    <div id="pagination-controls" class="flex justify-center items-center mt-8 space-x-2">
                        <!-- Pagination buttons will be inserted here -->
                    </div>
                    <div id="no-sales-message" class="text-center py-16 text-[var(--text-muted-color)] card rounded-2xl hidden">
                        <i class="fas fa-box-open text-5xl mb-4"></i>
                        <p class="text-lg font-semibold">အရောင်းစာရင်းမရှိသေးပါ</p>
                        <p class="text-sm mt-2">အပေါ်ရှိ Form မှ စာရင်းအသစ်များ စတင်ထည့်သွင်းနိုင်ပါသည်</p>
                    </div>
                </div>
            </div>

            <!-- Monthly View Content -->
            <div id="monthly-view" class="hidden fade-in">
                 <div class="w-full">
                    <h2 class="text-2xl font-bold mb-4">လချုပ်စာရင်း</h2>
                    <div id="monthly-summary-table-container" class="card rounded-2xl overflow-hidden">
                        <!-- Monthly summary table will be here -->
                    </div>
                 </div>
                 <div id="no-monthly-data-message" class="text-center py-16 text-[var(--text-muted-color)] card rounded-2xl hidden mt-8">
                        <i class="fas fa-chart-area text-5xl mb-4"></i>
                        <p class="text-lg font-semibold">လချုပ်စာရင်း မရှိသေးပါ</p>
                    </div>
            </div>
        </main>
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-lg p-5 shadow-lg rounded-2xl card border-[var(--border-color)]">
            <div class="flex justify-between items-center border-b border-[var(--border-color)] pb-3 mb-4">
                 <h3 class="text-xl font-bold">အရောင်းစာရင်းပြင်ဆင်ရန်</h3>
                 <button id="close-modal-btn" class="text-[var(--text-muted-color)] hover:text-[var(--text-color)] text-2xl">&times;</button>
            </div>
            <form id="edit-sale-form" class="space-y-4">
                <input type="hidden" id="edit-sale-id">
                <div>
                    <label for="edit-sale-date" class="block text-sm font-medium text-[var(--text-muted-color)]">ရက်စွဲ</label>
                    <input type="date" id="edit-sale-date" class="mt-1 w-full form-input px-4 py-2 rounded-lg focus:ring-2" required>
                </div>
                 <div>
                    <label for="edit-product-name" class="block text-sm font-medium text-[var(--text-muted-color)]">Product</label>
                    <input type="text" id="edit-product-name" class="mt-1 w-full form-input px-4 py-2 rounded-lg focus:ring-2" required>
                </div>
                <div>
                    <label for="edit-vpn-plan" class="block text-sm font-medium text-[var(--text-muted-color)]">Plan</label>
                    <input type="text" id="edit-vpn-plan" class="mt-1 w-full form-input px-4 py-2 rounded-lg focus:ring-2" required>
                </div>
                <div>
                    <label for="edit-quantity" class="block text-sm font-medium text-[var(--text-muted-color)]">အရေအတွက်</label>
                    <input type="number" id="edit-quantity" min="1" class="mt-1 w-full form-input px-4 py-2 rounded-lg focus:ring-2" required>
                </div>
                <div>
                    <label for="edit-price" class="block text-sm font-medium text-[var(--text-muted-color)]">ရောင်းဈေး (တစ်ခု)</label>
                    <input type="number" id="edit-price" min="0" class="mt-1 w-full form-input px-4 py-2 rounded-lg focus:ring-2" required>
                </div>
                 <div>
                    <label for="edit-cost" class="block text-sm font-medium text-[var(--text-muted-color)]">ကုန်ကျငွေ (တစ်ခု)</label>
                    <input type="number" id="edit-cost" min="0" class="mt-1 w-full form-input px-4 py-2 rounded-lg focus:ring-2" required>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">မလုပ်တော့ပါ</button>
                    <button type="submit" id="save-edit-btn" class="btn bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center">
                        <span>သိမ်းဆည်းမည်</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-modal" class="modal fixed inset-0 bg-black bg-opacity-50 h-full w-full hidden z-50 flex items-start sm:items-center justify-center p-4">
        <div class="w-full max-w-lg p-5 shadow-lg rounded-2xl card border-[var(--border-color)] max-h-[90vh] overflow-y-auto my-8 sm:my-0">
            <div class="flex justify-between items-center border-b border-[var(--border-color)] pb-3 mb-4">
                 <h3 class="text-xl font-bold">Profile Settings</h3>
                 <button id="close-profile-modal-btn" class="text-[var(--text-muted-color)] hover:text-[var(--text-color)] text-2xl">&times;</button>
            </div>
            
            <!-- Change Password Form -->
            <form id="change-password-form" class="space-y-4">
                <h4 class="font-semibold text-lg">Change Password</h4>
                <div>
                    <label for="current-password" class="block text-sm font-medium text-[var(--text-muted-color)]">Current Password</label>
                    <input type="password" id="current-password" class="mt-1 w-full form-input px-4 py-2 rounded-lg focus:ring-2" required>
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-[var(--text-muted-color)]">New Password</label>
                    <input type="password" id="new-password" class="mt-1 w-full form-input px-4 py-2 rounded-lg focus:ring-2" required>
                </div>
                <div class="pt-2 flex justify-end">
                    <button type="submit" id="save-password-btn" class="btn btn-primary-solid text-white font-bold py-2 px-4 rounded-lg">
                        <span class="btn-text">Update Password</span>
                        <i class="fas fa-spinner spinner hidden ml-2"></i>
                    </button>
                </div>
            </form>

            <div class="border-t border-[var(--border-color)] my-6"></div>

            <!-- Change Email Form -->
            <form id="change-email-form" class="space-y-4">
                <h4 class="font-semibold text-lg">Change Email</h4>
                <p class="text-sm text-[var(--text-muted-color)]">Note: You may be required to log in again after changing your email.</p>
                <div>
                    <label for="new-email" class="block text-sm font-medium text-[var(--text-muted-color)]">New Email</label>
                    <input type="email" id="new-email" class="mt-1 w-full form-input px-4 py-2 rounded-lg focus:ring-2" required>
                </div>
                <div class="pt-2 flex justify-end">
                    <button type="submit" id="save-email-btn" class="btn btn-primary-solid text-white font-bold py-2 px-4 rounded-lg">
                        <span class="btn-text">Update Email</span>
                        <i class="fas fa-spinner spinner hidden ml-2"></i>
                    </button>
                </div>
            </form>
            
            <!-- Danger Zone: Delete Account -->
            <div class="border-t border-red-500/30 my-6 pt-6">
                <h4 class="font-semibold text-lg text-red-500">Danger Zone</h4>
                <p class="text-sm text-[var(--text-muted-color)] mt-1">This action is irreversible. All your sales data will be permanently deleted.</p>
                <form id="delete-account-form" class="space-y-4 mt-4">
                     <div>
                        <label for="delete-password" class="block text-sm font-medium text-[var(--text-muted-color)]">Enter Your Password to Confirm</label>
                        <input type="password" id="delete-password" class="mt-1 w-full form-input px-4 py-2 rounded-lg focus:ring-2" required>
                    </div>
                    <div class="pt-2 flex justify-end">
                        <button type="submit" id="delete-account-btn" class="btn bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">
                            <span class="btn-text">Delete My Account</span>
                            <i class="fas fa-spinner spinner hidden ml-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODIFICATION: New Modals for More Menu -->
    <!-- About Modal -->
    <div id="about-modal" class="modal fixed inset-0 bg-black bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-lg p-6 shadow-lg rounded-2xl card border-[var(--border-color)]">
            <div class="flex justify-between items-center border-b border-[var(--border-color)] pb-3 mb-4">
                 <h3 class="text-xl font-bold">About SalesDash</h3>
                 <button id="close-about-modal-btn" class="text-[var(--text-muted-color)] hover:text-[var(--text-color)] text-2xl">&times;</button>
            </div>
            <div class="space-y-4 text-sm">
                <p><span class="font-semibold">Version:</span> 1.2.0 (New Login UI & More Menu)</p>
                <h4 class="font-semibold text-lg mt-4">What's New in SalesDash</h4>
                <ul class="list-disc list-inside space-y-2 text-[var(--text-muted-color)]">
                    <li>Login Page အတွက် ခေတ်မီသော ဒီဇိုင်းအသစ်။</li>
                    <li>Profile Pop-up ကို Mobile device များတွင် ပိုမိုကောင်းမွန်အောင်ပြုပြင်ထားခြင်း။</li>
                    <li>"More" Menu အသစ်နှင့် အချက်အလက်အသစ်များ ထပ်တိုးထားခြင်း။</li>
                    <li>အသေးစား UI ပြင်ဆင်မှုများနှင့် စွမ်းဆောင်ရည်မြှင့်တင်မှုများ။</li>
                </ul>
            </div>
             <div class="pt-4 mt-4 flex justify-end">
                <button type="button" id="about-modal-ok-btn" class="btn btn-primary-solid text-white font-bold py-2 px-6 rounded-lg">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Security Modal -->
    <div id="security-modal" class="modal fixed inset-0 bg-black bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-lg p-6 shadow-lg rounded-2xl card border-[var(--border-color)]">
            <div class="flex justify-between items-center border-b border-[var(--border-color)] pb-3 mb-4">
                 <h3 class="text-xl font-bold">Security</h3>
                 <button id="close-security-modal-btn" class="text-[var(--text-muted-color)] hover:text-[var(--text-color)] text-2xl">&times;</button>
            </div>
            <div class="space-y-4 text-sm text-[var(--text-muted-color)]">
                <p>သင်၏ account လုံခြုံရေးအတွက် password ကို ပုံမှန်ပြောင်းလဲပေးပါ။ သင်၏ password ကို မည်သူ့ကိုမျှ မမျှဝေပါနှင့်။</p>
                <p>ကျွန်ုပ်တို့သည် သင်၏အချက်အလက်များကို ကာကွယ်ရန် နောက်ဆုံးပေါ်လုံခြုံရေးစံနှုန်းများကို အသုံးပြုထားပါသည်။</p>
            </div>
             <div class="pt-4 mt-4 flex justify-end">
                <button type="button" id="security-modal-ok-btn" class="btn btn-primary-solid text-white font-bold py-2 px-6 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div id="privacy-modal" class="modal fixed inset-0 bg-black bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-lg p-6 shadow-lg rounded-2xl card border-[var(--border-color)]">
            <div class="flex justify-between items-center border-b border-[var(--border-color)] pb-3 mb-4">
                 <h3 class="text-xl font-bold">Personal Data & Privacy</h3>
                 <button id="close-privacy-modal-btn" class="text-[var(--text-muted-color)] hover:text-[var(--text-color)] text-2xl">&times;</button>
            </div>
            <div class="space-y-4 text-sm text-[var(--text-muted-color)]">
                <p>သင်၏ အချက်အလက်အားလုံးကို သင်၏ account အောက်တွင်သာ Firebase Firestore Database ကို အသုံးပြု၍ လုံခြုံစွာသိမ်းဆည်းထားပါသည်။</p>
                <p>သင်၏ ခွင့်ပြုချက်မရှိဘဲ သင်၏ data များကို မည်သူတစ်ဦးတစ်ယောက်ကိုမျှ မျှဝေမည်မဟုတ်ပါ။ သင်သည် သင်၏ data များကို အချိန်မရွေး export လုပ်နိုင်ပြီး account ကိုလည်း အပြီးတိုင်ဖျက်ပစ်နိုင်ပါသည်။</p>
            </div>
             <div class="pt-4 mt-4 flex justify-end">
                <button type="button" id="privacy-modal-ok-btn" class="btn btn-primary-solid text-white font-bold py-2 px-6 rounded-lg">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Developer Modal -->
    <div id="developer-modal" class="modal fixed inset-0 bg-black bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-lg p-6 shadow-lg rounded-2xl card border-[var(--border-color)]">
            <div class="flex justify-between items-center border-b border-[var(--border-color)] pb-3 mb-4">
                 <h3 class="text-xl font-bold">Developer Information</h3>
                 <button id="close-developer-modal-btn" class="text-[var(--text-muted-color)] hover:text-[var(--text-color)] text-2xl">&times;</button>
            </div>
            <div class="space-y-4 text-sm text-[var(--text-muted-color)]">
                <p>ဤ Sales Dashboard Application ကို KarKar(Unlocker) မှ မွမ်းမံတည်ဆောက်ထားပါသည်။</p>
                <p>အကြံပြုချက်များ၊ အကူအညီများလိုအပ်ပါက သို့မဟုတ် လုပ်ဆောင်ချက်အသစ်များထပ်မံတောင်းဆိုလိုပါက ပြောကြားနိုင်ပါသည်။</p>
            </div>
             <div class="pt-4 mt-4 flex justify-end">
                <button type="button" id="developer-modal-ok-btn" class="btn btn-primary-solid text-white font-bold py-2 px-6 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-md p-6 shadow-lg rounded-2xl card border-[var(--border-color)] text-center">
            <div class="mb-4">
                <i class="fas fa-exclamation-triangle text-4xl text-yellow-500"></i>
            </div>
            <h3 id="confirm-title" class="text-lg font-semibold mb-2">Are you sure?</h3>
            <p id="confirm-text" class="text-sm text-[var(--text-muted-color)] mb-6">You won't be able to revert this!</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="btn bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirm-ok-btn" class="btn bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Yes, delete it!</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 w-80 rounded-lg shadow-lg hidden z-50">
        <!-- Content will be injected by JS -->
    </div>

    <!-- =============================================================== -->
    <!-- START: Firebase Configuration -->
    <!-- =============================================================== -->
    <!-- To run this on your own website (like GitHub Pages), you need to -->
    <!-- create your own Firebase project and paste your configuration   -->
    <!-- object here. Get it from:                                       -->
    <!-- Firebase Console > Project Settings > General > Your apps > SDK setup and configuration -->
    <script>
        // PASTE YOUR FIREBASE CONFIG OBJECT HERE
        window.firebaseConfig = {
          apiKey: "AIzaSyDpPITUwHiRlxbC16gR7mBAhubEYtPhENQ",
          authDomain: "sales-dashboard-1100a.firebaseapp.com",
          projectId: "sales-dashboard-1100a",
          storageBucket: "sales-dashboard-1100a.appspot.com",
          messagingSenderId: "885128519230",
          appId: "1:885128519230:web:a626fd839f6523fab6bb6f"
        };
    </script>
    <!-- =============================================================== -->
    <!-- END: Firebase Configuration -->
    <!-- =============================================================== -->


    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, updatePassword, EmailAuthProvider, reauthenticateWithCredential, updateEmail, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc, serverTimestamp, enableIndexedDbPersistence, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- Secure Firebase Initialization ---
            let app, auth, db;
            let firebaseConfig;

            // Priority 1: Use config provided by the environment (e.g., Canvas)
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            } 
            // Priority 2: Use config provided by the user in the HTML
            else if (window.firebaseConfig) {
                firebaseConfig = window.firebaseConfig;
            } 
            // If no config is found, stop the app.
            else {
                console.error("Firebase configuration is missing. Please provide it in the HTML file.");
                document.body.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-red-100 text-red-700 p-4 text-center"><strong>Application Error:</strong> Firebase configuration is missing. Please follow the instructions in the HTML file to add your Firebase project configuration.</div>`;
                return;
            }

            try {
                // Initialize Firebase with the determined config
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.body.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-red-100 text-red-700 p-4 text-center"><strong>Application Error:</strong> Could not initialize Firebase. Please check if your configuration is correct.</div>`;
                return;
            }

            // Disable right-click context menu
            document.addEventListener('contextmenu', event => event.preventDefault());

            // Enable Offline Persistence
            enableIndexedDbPersistence(db)
                .catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code == 'unimplemented') {
                        console.warn('The current browser does not support all of the features required to enable persistence.');
                    }
                });

            let allSales = [];
            let filteredSales = [];
            let unsubscribeFromSales;
            let confirmCallback = null;
            let currentPage = 1;
            const ITEMS_PER_PAGE = 9;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


            const el = (id) => document.getElementById(id);

            // --- Element Cache ---
            const authSection = el('auth-section'), appSection = el('app'), loginForm = el('login-form'),
                  emailInput = el('email'), passwordInput = el('password'), loginBtn = el('login-btn'),
                  registerBtn = el('register-btn'), logoutBtn = el('logout-btn'), authError = el('auth-error'),
                  userEmailDisplay = el('user-email-display'), dropdownUserEmail = el('dropdown-user-email'), 
                  addSaleForm = el('add-sale-form'),
                  saleDateInput = el('sale-date'), productNameInput = el('product-name'),
                  vpnPlanInput = el('vpn-plan'), quantityInput = el('quantity'), priceInput = el('price'),
                  costInput = el('cost'), salesListContainer = el('sales-list-container'),
                  todayTotalEl = el('today-total'), todayProfitEl = el('today-profit'),
                  monthTotalEl = el('month-total'), monthProfitEl = el('month-profit'),
                  noSalesMessage = el('no-sales-message'), 
                  filterStartDateInput = el('filter-start-date'), filterEndDateInput = el('filter-end-date'),
                  searchInput = el('search-input'),
                  clearFilterBtn = el('clear-filter-btn'), 
                  exportCsvBtn = el('export-csv-btn'),
                  exportAllCsvBtn = el('export-all-csv-btn'),
                  authThemeToggle = el('auth-theme-toggle'),
                  appThemeToggle = el('app-theme-toggle'),
                  editModal = el('edit-modal'),
                  editSaleForm = el('edit-sale-form'), editSaleIdInput = el('edit-sale-id'),
                  editSaleDateInput = el('edit-sale-date'), editProductNameInput = el('edit-product-name'),
                  editVpnPlanInput = el('edit-vpn-plan'), editQuantityInput = el('edit-quantity'),
                  editPriceInput = el('edit-price'), editCostInput = el('edit-cost'),
                  cancelEditBtn = el('cancel-edit-btn'), closeModalBtn = el('close-modal-btn'),
                  saveEditBtn = el('save-edit-btn'), addSaleBtn = el('add-sale-btn'),
                  tabDaily = el('tab-daily'), tabMonthly = el('tab-monthly'), dailyView = el('daily-view'),
                  monthlyView = el('monthly-view'), monthlySummaryTableContainer = el('monthly-summary-table-container'),
                  noMonthlyDataMessage = el('no-monthly-data-message'), confirmModal = el('confirm-modal'),
                  confirmTitle = el('confirm-title'), confirmText = el('confirm-text'),
                  confirmCancelBtn = el('confirm-cancel-btn'), confirmOkBtn = el('confirm-ok-btn'),
                  toastEl = el('toast'), productDatalist = el('product-list'), planDatalist = el('plan-list'),
                  paginationControls = el('pagination-controls'),
                  connectionStatusEl = el('connection-status'),
                  profileModal = el('profile-modal'),
                  closeProfileModalBtn = el('close-profile-modal-btn'),
                  changePasswordForm = el('change-password-form'),
                  currentPasswordInput = el('current-password'),
                  newPasswordInput = el('new-password'),
                  savePasswordBtn = el('save-password-btn'),
                  changeEmailForm = el('change-email-form'),
                  newEmailInput = el('new-email'),
                  saveEmailBtn = el('save-email-btn'),
                  deleteAccountForm = el('delete-account-form'),
                  deletePasswordInput = el('delete-password'),
                  deleteAccountBtn = el('delete-account-btn'),
                  moreMenuBtn = el('more-menu-btn'),
                  moreMenuDropdown = el('more-menu-dropdown'),
                  menuProfileBtn = el('menu-profile-btn'),
                  menuSecurityBtn = el('menu-security-btn'),
                  menuPrivacyBtn = el('menu-privacy-btn'),
                  menuAboutBtn = el('menu-about-btn'),
                  menuDeveloperBtn = el('menu-developer-btn'),
                  aboutModal = el('about-modal'), closeAboutModalBtn = el('close-about-modal-btn'), aboutModalOkBtn = el('about-modal-ok-btn'),
                  securityModal = el('security-modal'), closeSecurityModalBtn = el('close-security-modal-btn'), securityModalOkBtn = el('security-modal-ok-btn'),
                  privacyModal = el('privacy-modal'), closePrivacyModalBtn = el('close-privacy-modal-btn'), privacyModalOkBtn = el('privacy-modal-ok-btn'),
                  developerModal = el('developer-modal'), closeDeveloperModalBtn = el('close-developer-modal-btn'), developerModalOkBtn = el('developer-modal-ok-btn');


            // --- Utility Functions ---
            const formatCurrency = (amount) => `${Math.round(amount).toLocaleString()} MMK`;
            
            const toggleButtonLoading = (button, isLoading) => {
                const btnText = button.querySelector('.btn-text');
                const spinner = button.querySelector('.spinner');
                if (button) {
                    button.disabled = isLoading;
                    if (isLoading) {
                        if (btnText) btnText.style.display = 'none';
                        if (spinner) spinner.classList.remove('hidden');
                    } else {
                        if (btnText) btnText.style.display = '';
                        if (spinner) spinner.classList.add('hidden');
                    }
                }
            };

            const showToast = (message, type = 'success') => {
                const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-[var(--toast-bg)]';
                const icon = type === 'error' ? 'fa-times-circle' : 'fa-check-circle';
                
                toastEl.innerHTML = `
                    <div class="flex items-center p-4 ${bgColor} text-white rounded-lg shadow-lg">
                        <i class="fas ${icon} mr-3 text-xl"></i>
                        <div class="flex-1 text-sm font-medium">${message}</div>
                    </div>
                `;
                toastEl.classList.remove('hidden', 'toast-out');
                toastEl.classList.add('toast-in');

                setTimeout(() => {
                    toastEl.classList.remove('toast-in');
                    toastEl.classList.add('toast-out');
                }, 3000);
            };
            
            const updateConnectionStatus = (online) => {
                if (online) {
                    connectionStatusEl.classList.remove('bg-yellow-500', 'bg-gray-400');
                    connectionStatusEl.classList.add('bg-green-500');
                    connectionStatusEl.title = 'Online';
                } else {
                    connectionStatusEl.classList.remove('bg-green-500', 'bg-gray-400');
                    connectionStatusEl.classList.add('bg-yellow-500');
                    connectionStatusEl.title = 'Offline - Changes will sync when back online';
                }
            };

            // --- Auth Event Handlers ---
            const setAuthFormState = (isBusy) => {
                loginBtn.disabled = isBusy;
                registerBtn.disabled = isBusy;
                toggleButtonLoading(loginBtn, isBusy);
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                authError.textContent = '';
                authError.classList.remove('text-green-500', 'text-red-500');
                setAuthFormState(true);

                try {
                    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                } catch (error) {
                    authError.textContent = getAuthErrorMessage(error.code);
                    authError.classList.add('text-red-500');
                } finally {
                    setAuthFormState(false);
                }
            };

            const handleRegister = async () => {
                authError.textContent = '';
                authError.classList.remove('text-green-500', 'text-red-500');
                setAuthFormState(true);

                try {
                    await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                    await signOut(auth);
                    
                    authError.textContent = 'Registration successful. Please log in.';
                    authError.classList.add('text-green-500');
                    loginForm.reset();
                } catch (error) {
                    authError.textContent = getAuthErrorMessage(error.code);
                    authError.classList.add('text-red-500');
                } finally {
                    setAuthFormState(false);
                }
            };
            
            function getAuthErrorMessage(code) {
                switch (code) {
                    case 'auth/invalid-email': return 'Invalid email address.';
                    case 'auth/user-not-found': return 'No account found with this email.';
                    case 'auth/wrong-password': return 'Incorrect password.';
                    case 'auth/weak-password': return 'Password should be at least 6 characters.';
                    case 'auth/email-already-in-use': return 'This email is already registered.';
                    case 'auth/requires-recent-login': return 'This action is sensitive and requires recent authentication. Please log in again.';
                    default: return 'An unknown error occurred.';
                }
            }

            // --- Theme Management ---
            const applyTheme = (theme) => {
                document.documentElement.className = theme;
                authThemeToggle.checked = theme === 'dark';
                appThemeToggle.checked = theme === 'dark';
            };

            const toggleTheme = () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            };

            // --- UI Rendering & Updates ---
            const setDefaultDate = () => saleDateInput.value = new Date().toISOString().split('T')[0];
            
            const updateDashboardUI = () => {
                applyFiltersAndRender();
                updateSummaryCards();
                updateMonthlySummary();
                updateDatalists();
            };
            
            const applyFiltersAndRender = () => {
                const startDate = filterStartDateInput.value;
                const endDate = filterEndDateInput.value;
                const searchTerm = searchInput.value.toLowerCase();

                filteredSales = allSales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    
                    if (start && saleDate < start) return false;
                    if (end && saleDate > end) return false;

                    const matchesSearch = searchTerm === '' ||
                        sale.product.toLowerCase().includes(searchTerm) ||
                        sale.plan.toLowerCase().includes(searchTerm);

                    return matchesSearch;
                });
                
                currentPage = 1; // Reset to first page after filtering
                renderPaginatedSales();
                renderPaginationControls();
            };

            function updateSummaryCards() {
                let todayTotal = 0, todayProfit = 0, monthTotal = 0, monthProfit = 0;
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                const currentMonthString = today.toISOString().slice(0, 7);

                allSales.forEach(sale => {
                    const total = sale.quantity * sale.price;
                    const profit = (sale.price - (sale.cost || 0)) * sale.quantity;
                    
                    if (sale.date === todayString) {
                        todayTotal += total;
                        todayProfit += profit;
                    }
                    if (sale.date && sale.date.startsWith(currentMonthString)) {
                        monthTotal += total;
                        monthProfit += profit;
                    }
                });
                
                todayTotalEl.textContent = formatCurrency(todayTotal);
                todayProfitEl.textContent = formatCurrency(todayProfit);
                monthTotalEl.textContent = formatCurrency(monthTotal);
                monthProfitEl.textContent = formatCurrency(monthProfit);
            }

            function renderPaginatedSales() {
                const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                const salesToRender = filteredSales.slice(startIndex, endIndex);

                salesListContainer.innerHTML = '';
                noSalesMessage.classList.toggle('hidden', filteredSales.length > 0);

                salesToRender.forEach((sale, index) => {
                    const profit = (sale.price - (sale.cost || 0)) * sale.quantity;
                    const card = document.createElement('div');
                    card.className = 'card rounded-xl p-5 flex flex-col space-y-4 fade-in';
                    card.style.animationDelay = `${index * 50}ms`;
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg">${sale.product}</p>
                                <p class="text-sm text-[var(--text-muted-color)]">${sale.plan}</p>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="text-xs text-[var(--text-muted-color)]">${sale.date}</p>
                                <div class="mt-2">
                                    <button data-id="${sale.id}" class="edit-btn text-indigo-400 hover:text-indigo-600 w-8 h-8 rounded-full hover:bg-indigo-100 dark:hover:bg-indigo-900/50"><i class="fas fa-pencil-alt"></i></button>
                                    <button data-id="${sale.id}" class="delete-btn text-red-400 hover:text-red-600 w-8 h-8 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-[var(--border-color)] my-2"></div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <span class="text-[var(--text-muted-color)]">အရေအတွက်:</span>
                            <span class="font-medium text-right">${sale.quantity}</span>
                            <span class="text-[var(--text-muted-color)]">ရောင်းဈေး:</span>
                            <span class="font-medium text-right">${formatCurrency(sale.price)}</span>
                            <span class="text-[var(--text-muted-color)]">ကုန်ကျငွေ:</span>
                            <span class="font-medium text-right">${formatCurrency(sale.cost || 0)}</span>
                        </div>
                        <div class="border-t border-[var(--border-color)] my-2"></div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-semibold text-base">အမြတ်:</span>
                            <span class="font-bold text-lg ${profit >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(profit)}</span>
                        </div>
                    `;
                    salesListContainer.appendChild(card);
                });
            }

            function renderPaginationControls() {
                paginationControls.innerHTML = '';
                const pageCount = Math.ceil(filteredSales.length / ITEMS_PER_PAGE);
                if (pageCount <= 1) return;

                for (let i = 1; i <= pageCount; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.className = `pagination-btn btn rounded-lg p-2 ${i === currentPage ? 'active' : 'bg-[var(--card-bg-color)]'}`;
                    button.addEventListener('click', () => {
                        currentPage = i;
                        renderPaginatedSales();
                        renderPaginationControls();
                    });
                    paginationControls.appendChild(button);
                }
            }
            
            function calculateMonthlySummary() {
                const monthlyData = {};
                allSales.forEach(sale => {
                    const month = sale.date.substring(0, 7);
                    if (!monthlyData[month]) {
                        monthlyData[month] = { total: 0, profit: 0, count: 0 };
                    }
                    monthlyData[month].total += sale.price * sale.quantity;
                    monthlyData[month].profit += (sale.price - sale.cost) * sale.quantity;
                    monthlyData[month].count += sale.quantity;
                });
                return Object.entries(monthlyData)
                             .map(([month, data]) => ({ month, ...data }))
                             .sort((a, b) => a.month.localeCompare(b.month));
            }

            function updateMonthlySummary() {
                const summaryData = calculateMonthlySummary();
                renderMonthlyTable(summaryData.slice().reverse());
                const hasData = summaryData.length > 0;
                monthlyView.querySelector('.w-full').classList.toggle('hidden', !hasData);
                noMonthlyDataMessage.classList.toggle('hidden', hasData);
            }

            function renderMonthlyTable(data) {
                let tableHTML = `
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-[var(--text-muted-color)] uppercase bg-[var(--bg-color)]">
                            <tr>
                                <th scope="col" class="px-6 py-3">လ</th>
                                <th scope="col" class="px-6 py-3 text-right">ရောင်းရငွေ</th>
                                <th scope="col" class="px-6 py-3 text-right">အမြတ်</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                data.forEach(item => {
                    tableHTML += `
                        <tr class="border-b border-[var(--border-color)]">
                            <th scope="row" class="px-6 py-4 font-medium whitespace-nowrap">${item.month}</th>
                            <td class="px-6 py-4 text-right">${formatCurrency(item.total)}</td>
                            <td class="px-6 py-4 text-right font-bold ${item.profit >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(item.profit)}</td>
                        </tr>
                    `;
                });
                tableHTML += `</tbody></table>`;
                monthlySummaryTableContainer.innerHTML = tableHTML;
            }

            function updateDatalists() {
                const products = [...new Set(allSales.map(s => s.product))];
                const plans = [...new Set(allSales.map(s => s.plan))];
                productDatalist.innerHTML = products.map(p => `<option value="${p}"></option>`).join('');
                planDatalist.innerHTML = plans.map(p => `<option value="${p}"></option>`).join('');
            }
            
            // --- Modal Management ---
            const openModal = (modal) => modal.classList.remove('hidden');
            const closeModal = (modal) => modal.classList.add('hidden');

            const openEditModal = (sale) => {
                editSaleIdInput.value = sale.id; editSaleDateInput.value = sale.date;
                editProductNameInput.value = sale.product || ''; editVpnPlanInput.value = sale.plan || '';
                editQuantityInput.value = sale.quantity; editPriceInput.value = sale.price;
                editCostInput.value = sale.cost || 0;
                openModal(editModal);
            };

            const closeEditModal = () => {
                closeModal(editModal);
                editSaleForm.reset();
            };
            
            const openProfileModal = () => {
                openModal(profileModal);
                changePasswordForm.reset();
                changeEmailForm.reset();
                deleteAccountForm.reset();
            };

            const showConfirmModal = (title, text, onConfirm) => {
                confirmTitle.textContent = title;
                confirmText.textContent = text;
                confirmCallback = onConfirm;
                openModal(confirmModal);
            };

            const closeConfirmModal = () => {
                closeModal(confirmModal);
                confirmCallback = null;
            };

            // --- Firestore Handlers ---
            async function handleAddSale(e) {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;

                toggleButtonLoading(addSaleBtn, true);
                
                const newSale = {
                    date: saleDateInput.value,
                    product: productNameInput.value.trim() || 'N/A',
                    plan: vpnPlanInput.value.trim(),
                    quantity: parseInt(quantityInput.value),
                    price: parseFloat(priceInput.value),
                    cost: parseFloat(costInput.value) || 0,
                    timestamp: serverTimestamp()
                };
                
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'sales'), newSale);
                    showToast("စာရင်းသွင်းခြင်း အောင်မြင်ပါသည်။", "success");
                    addSaleForm.reset();
                    setDefaultDate();
                    productNameInput.value = 'VPN'; 
                    vpnPlanInput.value = '1 Month'; 
                    quantityInput.value = '1';
                    priceInput.value = '';
                    costInput.value = '0';
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showToast("စာရင်းသွင်းရာတွင် အမှားအယွင်းဖြစ်သွားပါသည်။", "error");
                } finally {
                    toggleButtonLoading(addSaleBtn, false);
                }
            }
            
            function handleListClick(e) {
                const button = e.target.closest('button');
                if (!button) return;
                const saleId = button.dataset.id;
                if (!saleId) return;

                if (button.classList.contains('delete-btn')) {
                    showConfirmModal('စာရင်းဖျက်ရန်', 'ဤစာရင်းကို ဖျက်ရန်သေချာပါသလား?', () => {
                        const user = auth.currentUser;
                        if (!user) return;
                        deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'sales', saleId))
                            .then(() => {
                                showToast("စာရင်းကိုအောင်မြင်စွာဖျက်ပြီးပါပြီ။", "success");
                            })
                            .catch((error) => {
                                console.error("Error deleting document: ", error);
                                showToast("စာရင်းဖျက်ရာတွင် အမှားအယွင်းဖြစ်သွားပါသည်။", "error");
                            });
                    });
                }
                if (button.classList.contains('edit-btn')) {
                    const saleToEdit = allSales.find(sale => sale.id === saleId);
                    if (saleToEdit) openEditModal(saleToEdit);
                }
            }

            async function handleUpdateSale(e) {
                e.preventDefault();
                const saleId = editSaleIdInput.value;
                const user = auth.currentUser;
                if (!user) return;

                toggleButtonLoading(saveEditBtn, true);
                
                const saleRef = doc(db, 'artifacts', appId, 'users', user.uid, 'sales', saleId);
                const updatedData = {
                    date: editSaleDateInput.value,
                    product: editProductNameInput.value.trim() || 'N/A',
                    plan: editVpnPlanInput.value.trim(),
                    quantity: parseInt(editQuantityInput.value),
                    price: parseFloat(editPriceInput.value),
                    cost: parseFloat(editCostInput.value) || 0,
                };

                try {
                    await updateDoc(saleRef, updatedData);
                    showToast("စာရင်းပြင်ဆင်ခြင်း အောင်မြင်ပါသည်။", "success");
                    closeEditModal();
                } catch (error) {
                    console.error("Error updating document: ", error);
                    showToast("စာရင်းပြင်ဆင်ရာတွင် အမှားအယွင်းဖြစ်သွားပါသည်။", "error");
                } finally {
                    toggleButtonLoading(saveEditBtn, false);
                }
            }
            
            function handleExport(dataSource, type) {
                if (dataSource.length === 0) {
                    showToast(`"${type}" export လုပ်ရန် data မရှိပါ။`, 'error');
                    return;
                }
                const headers = ['ID', 'Date', 'Product', 'Plan', 'Quantity', 'Price', 'Cost', 'Total', 'Profit'];
                const rows = dataSource.map(sale => {
                    const total = sale.quantity * sale.price;
                    const profit = (sale.price - (sale.cost || 0)) * sale.quantity;
                    return [sale.id, sale.date, sale.product, sale.plan, sale.quantity, sale.price, sale.cost || 0, total, profit]
                           .map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
                });
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `sales_export_${type}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function setupRealtimeListener(userId) {
                console.log(`Setting up real-time listener for user: ${userId} and appId: ${appId}`);
                const salesCollectionForUser = collection(db, 'artifacts', appId, 'users', userId, 'sales');
                const q = query(salesCollectionForUser);
                
                if (unsubscribeFromSales) unsubscribeFromSales();

                unsubscribeFromSales = onSnapshot(q, (querySnapshot) => {
                    const isOffline = querySnapshot.metadata.fromCache;
                    updateConnectionStatus(!isOffline);
                    console.log(`Received ${querySnapshot.docs.length} sales records from Firestore. From cache: ${isOffline}`);

                    allSales = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    allSales.sort((a, b) => {
                        const dateA = a.timestamp ? a.timestamp.toDate() : new Date(a.date);
                        const dateB = b.timestamp ? b.timestamp.toDate() : new Date(b.date);
                        return dateB - dateA;
                    });

                    updateDashboardUI();
                }, (error) => {
                    console.error("Firestore real-time listener error:", error);
                    showToast("Error fetching data. Check console for details.", "error");
                    updateConnectionStatus(false);
                });
            }

            // --- Profile Management ---
            const handleChangePassword = async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                const currentPassword = currentPasswordInput.value;
                const newPassword = newPasswordInput.value;

                if (!user) return;
                if (newPassword.length < 6) {
                    showToast("New password must be at least 6 characters.", "error");
                    return;
                }

                toggleButtonLoading(savePasswordBtn, true);

                try {
                    const credential = EmailAuthProvider.credential(user.email, currentPassword);
                    await reauthenticateWithCredential(user, credential);
                    await updatePassword(user, newPassword);
                    showToast("Password updated successfully!", "success");
                    changePasswordForm.reset();
                } catch (error) {
                    console.error("Error updating password:", error);
                    showToast(getAuthErrorMessage(error.code), "error");
                } finally {
                    toggleButtonLoading(savePasswordBtn, false);
                }
            };

            const handleChangeEmail = async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                const newEmail = newEmailInput.value;

                if (!user || user.email === newEmail) return;

                toggleButtonLoading(saveEmailBtn, true);

                try {
                    await updateEmail(user, newEmail);
                    showToast("Email updated successfully! Please log in again.", "success");
                    setTimeout(() => signOut(auth), 2000);
                } catch (error) {
                    console.error("Error updating email:", error);
                    showToast(getAuthErrorMessage(error.code), "error");
                } finally {
                    toggleButtonLoading(saveEmailBtn, false);
                }
            };
            
            const handleDeleteAccount = async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                const password = deletePasswordInput.value;

                if (!user || !password) return;

                toggleButtonLoading(deleteAccountBtn, true);
                
                try {
                    // 1. Re-authenticate user
                    const credential = EmailAuthProvider.credential(user.email, password);
                    await reauthenticateWithCredential(user, credential);

                    // 2. Delete all user data from Firestore
                    const salesCollectionRef = collection(db, 'artifacts', appId, 'users', user.uid, 'sales');
                    const querySnapshot = await getDocs(salesCollectionRef);
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    console.log("All user data deleted from Firestore.");

                    // 3. Delete the user account
                    await deleteUser(user);
                    showToast("Account deleted successfully.", "success");
                    closeModal(profileModal); 
                } catch (error) {
                    console.error("Error deleting account:", error);
                    showToast(getAuthErrorMessage(error.code), "error");
                } finally {
                    toggleButtonLoading(deleteAccountBtn, false);
                }
            };

            // --- Main App Initialization ---
            const initApp = () => {
                console.log(`Initializing app with Project ID: ${app.options.projectId} and App ID: ${appId}`);
                
                // Setup all event listeners
                authThemeToggle.addEventListener('change', toggleTheme);
                appThemeToggle.addEventListener('change', toggleTheme);
                loginForm.addEventListener('submit', handleLogin);
                registerBtn.addEventListener('click', handleRegister);
                logoutBtn.addEventListener('click', () => signOut(auth));
                addSaleForm.addEventListener('submit', handleAddSale);
                salesListContainer.addEventListener('click', handleListClick);
                
                [filterStartDateInput, filterEndDateInput, searchInput].forEach(el => {
                    el.addEventListener('input', applyFiltersAndRender);
                });

                clearFilterBtn.addEventListener('click', () => { 
                    filterStartDateInput.value = ''; 
                    filterEndDateInput.value = '';
                    searchInput.value = '';
                    applyFiltersAndRender(); 
                });
                
                exportCsvBtn.addEventListener('click', () => handleExport(filteredSales, 'filtered'));
                exportAllCsvBtn.addEventListener('click', () => handleExport(allSales, 'all'));
                
                editSaleForm.addEventListener('submit', handleUpdateSale);
                closeModalBtn.addEventListener('click', closeEditModal);
                cancelEditBtn.addEventListener('click', closeEditModal);
                editModal.addEventListener('click', (e) => { if (e.target === editModal) closeEditModal(); });

                // Profile Modal Listeners
                closeProfileModalBtn.addEventListener('click', () => closeModal(profileModal));
                profileModal.addEventListener('click', (e) => { if (e.target === profileModal) closeModal(profileModal); });
                changePasswordForm.addEventListener('submit', handleChangePassword);
                changeEmailForm.addEventListener('submit', handleChangeEmail);
                deleteAccountForm.addEventListener('submit', handleDeleteAccount);

                // More Menu Dropdown
                moreMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    moreMenuDropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', () => moreMenuDropdown.classList.add('hidden'));

                // New Menu Items
                menuProfileBtn.addEventListener('click', (e) => { e.preventDefault(); openProfileModal(); });
                menuAboutBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(aboutModal); });
                menuSecurityBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(securityModal); });
                menuPrivacyBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(privacyModal); });
                menuDeveloperBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(developerModal); });

                // New Modals Close Buttons
                closeAboutModalBtn.addEventListener('click', () => closeModal(aboutModal));
                aboutModalOkBtn.addEventListener('click', () => closeModal(aboutModal));
                closeSecurityModalBtn.addEventListener('click', () => closeModal(securityModal));
                securityModalOkBtn.addEventListener('click', () => closeModal(securityModal));
                closePrivacyModalBtn.addEventListener('click', () => closeModal(privacyModal));
                privacyModalOkBtn.addEventListener('click', () => closeModal(privacyModal));
                closeDeveloperModalBtn.addEventListener('click', () => closeModal(developerModal));
                developerModalOkBtn.addEventListener('click', () => closeModal(developerModal));


                confirmCancelBtn.addEventListener('click', closeConfirmModal);
                confirmOkBtn.addEventListener('click', () => {
                    if (confirmCallback) confirmCallback();
                    closeConfirmModal();
                });
                confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) closeConfirmModal(); });

                tabDaily.addEventListener('click', () => {
                    tabDaily.classList.add('active');
                    tabMonthly.classList.remove('active');
                    dailyView.classList.remove('hidden');
                    monthlyView.classList.add('hidden');
                });
                tabMonthly.addEventListener('click', () => {
                    tabMonthly.classList.add('active');
                    tabDaily.classList.remove('active');
                    monthlyView.classList.remove('hidden');
                    dailyView.classList.add('hidden');
                });

                window.addEventListener('online', () => updateConnectionStatus(true));
                window.addEventListener('offline', () => updateConnectionStatus(false));

                // Set initial state
                const savedTheme = localStorage.getItem('theme') || 
                                  (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(savedTheme);
                setDefaultDate();

                // --- Central Auth Handler ---
                onAuthStateChanged(auth, user => {
                    console.log("Auth state changed. User:", user ? user.uid : 'No User');
                    if (user && !user.isAnonymous) {
                        // User is logged in
                        console.log(`Authenticated as ${user.email}. Fetching data...`);
                        authSection.classList.add('hidden');
                        appSection.classList.remove('hidden');
                        userEmailDisplay.textContent = user.email;
                        dropdownUserEmail.textContent = user.email;
                        setupRealtimeListener(user.uid);
                    } else {
                        // User is logged out
                        console.log("User is logged out. Clearing data and showing login form.");
                        authSection.classList.remove('hidden');
                        appSection.classList.add('hidden');
                        userEmailDisplay.textContent = '';
                        dropdownUserEmail.textContent = '';
                        if (unsubscribeFromSales) {
                            unsubscribeFromSales();
                        }
                        allSales = [];
                        updateDashboardUI();
                    }
                });

                // Handle initial auth if provided by the environment
                const attemptInitialSignIn = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            console.log("Attempting sign-in with provided token...");
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            console.log("No initial auth token found. Waiting for user login.");
                        }
                    } catch (error) {
                        console.error("Automatic sign-in with token failed:", error);
                        authError.textContent = "Session authentication failed.";
                    }
                };
                
                attemptInitialSignIn();
            };

            // Start the application
            initApp();
        });
    </script>
</body>
</html>
